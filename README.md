# AudioStreamer

AudioStreamer pairs a Flutter Android client with a Windows loopback capture server to mirror desktop audio onto a phone or tablet. The client can talk to the server using either an Opus over HTTP stream or an ultra low latency PCM tunnel that runs through `adb reverse`, making it useful for remote play, game streaming, or quick monitoring without external speakers.

## Repository Layout
- `lib/` - Flutter application code, built with Provider state management and `just_audio` for Opus playback.
- `android/app/src/main/kotlin/` - Android foreground service that pulls PCM frames over USB and feeds them into an `AudioTrack`.
- `win_server/AudioStreamer.Server/` - .NET 8 minimal API that captures system audio with WASAPI/NAudio, encodes Opus with Concentus, and exposes HTTP + raw TCP endpoints.
- Platform scaffolding (`ios`, `macos`, `linux`, `windows`, `web`) generated by Flutter if you want to extend beyond Android.

## Highlights
- Toggle between buffered Opus streaming and 10 ms PCM frames for latency-sensitive listening.
- Runtime server controls (bitrate, Opus frame size, flush interval, output device, gain) applied directly from the mobile app.
- Automatic `adb reverse` maintenance so USB-connected devices see `127.0.0.1:7350` (Opus) and `127.0.0.1:7352` (PCM).
- Foreground Android service keeps the PCM route alive even when the app is backgrounded.
- Shared preferences persist client settings across launches.
- Health monitor detects dropped connections and triggers exponential backoff retries.

## Quick Start

### 1. Run the Windows server
1. Install requirements: [.NET 8 SDK](https://dotnet.microsoft.com/), recent `adb` (Android platform tools), and a Windows 10/11 machine with loopback audio capture enabled.
2. Build and run:
   ```bash
   cd win_server/AudioStreamer.Server
   dotnet restore
   dotnet run
   ```
3. Watch the console for `AudioStreamer.Server listening on http://127.0.0.1:7350/stream.opus` and confirm `adb reverse` succeeded. Leave this window open while streaming.

### 2. Launch the Flutter client (Android)
1. Install [Flutter](https://docs.flutter.dev/) 3.22+ (Dart 3.9) and enable an Android device with USB debugging.
2. From the repository root:
   ```bash
   flutter pub get
   flutter run
   ```
3. When the app starts it attempts to auto-connect. Use the top-right edit icon to change the Opus URL if you are routing over Wi-Fi instead of USB.

## Client Controls
- **Low-latency (PCM over USB)** - switches between the foreground PCM service and the Opus player.
- **USB URL** - editable when Opus mode is active; stored in `SharedPreferences`.
- **Auto-connect on launch** - re-establishes the last mode at startup.
- **Preferences card** - adjust server bitrate, frame size, flush interval, output device, and software gain before tapping **Apply to Server**.
- **Status card** - shows connection state sourced from the `PlayerController` status stream.

## Server Endpoints
- `GET /stream.opus` - live Opus stream; single-client gated when enabled.
- `GET /config` - returns the current runtime configuration.
- `POST /config` - accepts JSON payloads to update the mutable config (the Flutter UI uses this endpoint).
- `GET /devices` - enumerates audio render devices so the client can populate its drop-down.
- `TCP :7352` - raw 48 kHz stereo PCM frames, 10 ms packets, for the Android foreground service.

### Environment Variables
Set before `dotnet run` or bake into a service wrapper to change defaults:

| Variable | Description | Default |
| --- | --- | --- |
| `AUDIOSTREAMER_PORT` | HTTP Opus port | `7350` |
| `AUDIOSTREAMER_PCM_PORT` | PCM TCP port | `7352` |
| `AUDIOSTREAMER_BITRATE` | Opus target bitrate (bps) | `320000` |
| `AUDIOSTREAMER_FRAME_MS` | Opus frame size in ms | `20` |
| `AUDIOSTREAMER_FLUSH_INTERVAL_MS` | Flush cadence to reduce USB jitter | `40` |
| `AUDIOSTREAMER_GAIN_DB` | Fixed gain applied before encoding | `0` |
| `AUDIOSTREAMER_DEVICE_ID` | WASAPI device ID to capture | Default render device |
| `AUDIOSTREAMER_ADB_REVERSE` | Enable periodic `adb reverse` | `true` |

## Development Tips
- `flutter analyze` and `flutter test` keep the Dart side lint-free (tests not yet implemented).
- `flutter run -d windows` lets you sanity check the UI on desktop without a device; PCM mode is Android-only.
- `dotnet watch run` provides hot reload on the server while tweaking capture logic.
- The PCM foreground service lives in `android/app/src/main/kotlin/com/example/audio_streamer/PcmService.kt`; update notification text or buffering there if needed.

## Troubleshooting
- **No audio in PCM mode** - confirm the console shows `[pcm] client connected`; if it disconnects quickly, check that `adb reverse tcp:7352 tcp:7352` succeeds and USB debugging is enabled.
- **Opus crackles or drifts** - lower `Flush` ms or bitrate, or switch to PCM mode for tighter sync.
- **Configuration changes do not stick** - verify the server stdout after pressing **Apply to Server**; errors are surfaced in the Flutter status feed.
- **Multiple listeners needed** - disable *Single client* by setting `AUDIOSTREAMER_SINGLE_CLIENT=false` and restart the server (the UI toggle will be added later).

Happy streaming!

